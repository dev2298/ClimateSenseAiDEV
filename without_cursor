USE [Main2Masters]
GO

/****** Object:  StoredProcedure [dbo].[Rollback_AccountMaster_Changes]    Script Date: 3/24/2025 7:23:29 AM ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

/********************************************************************************************  
SP Name			:	Rollback_AccountMaster_Changes 
Objective		:	Rollback Master Changes in case of failure
Created By		:   
Creation Date	:   Devansh Srivastava
Modified By		:	
Modified Date	:	21st March 2025  
Algorithm :		:   Query Log according to the BATCHID and perform corresponding negative operations on master table
  
*********************************************************************************************/  
CREATE PROCEDURE [dbo].[Rollback_AccountMaster_Changes]
    @BatchID UNIQUEIDENTIFIER
AS
BEGIN
    SET NOCOUNT ON;
    BEGIN TRANSACTION;

    -- Declare variables to store fetched values
    DECLARE @acc_id INT, @action VARCHAR(50);

    -- Cursor to process each record from account_master_log
    DECLARE rollback_cursor CURSOR FOR 
    SELECT acc_id, action
    FROM account_master_log
    WHERE BatchID = @BatchID;
	
    OPEN rollback_cursor;
    FETCH NEXT FROM rollback_cursor INTO @acc_id, @action;

    WHILE @@FETCH_STATUS = 0
    BEGIN
        -- Rollback INSERT: Delete the inserted record from account_master
		Select @action ;
        IF @action = 'I'
        BEGIN
            DELETE FROM account_master WHERE acc_id = @acc_id;
        END
        -- Rollback UPDATE: Delete from master and re-insert from log
        ELSE IF @action = 'U'
        BEGIN
			DELETE FROM dbo.ProcessExecutionLog 
			WHERE AccountID = @acc_id;
            DELETE FROM account_master WHERE acc_id = @acc_id;

            INSERT INTO account_master (
			acc_id,acc_name,acc_desc,ShortReportingName,LongReportingName,client_id,broker_id,base_curr,status,
			ReportingNameType,group_account,lock_date,handle_futures,account_type,error_limit,reporting_name,
			reporting_path,broker_trade_acceptance_limit,hold_equity,disabled_on_date,
			real_broker_id,MDMEntityTypeID,broker_acc_no,
			pns_style,default_accrual_source,interest_accrual_check_limit,
			dividend_accrual_check_limit,FundStartDate,AccountingEndDate,MDMTopicEntityID,MDMTradingBehaviour,
			MDMVersionNumber,MDMStartDate,MDMEndDate,version_date,version_source,MDMSlaPriority,
			CreateDate,EntityFlag,FasLockDate,BatchID )
            SELECT 
			acc_id,acc_name,acc_desc,ShortReportingName,LongReportingName,client_id,broker_id,base_curr,status,
			ReportingNameType,group_account,lock_date,handle_futures,account_type,error_limit,reporting_name,
			reporting_path,broker_trade_acceptance_limit,hold_equity,disabled_on_date,
			real_broker_id,MDMEntityTypeID,broker_acc_no,
			pns_style,default_accrual_source,interest_accrual_check_limit,
			dividend_accrual_check_limit,NULL,AccountingEndDate,MDMTopicEntityID,MDMTradingBehaviour,
			MDMVersionNumber,MDMStartDate,MDMEndDate,version_date,version_source,MDMSlaPriority,
			CreateDate,EntityFlag,FasLockDate,BatchID FROM account_master_log 
            WHERE acc_id = @acc_id AND BatchID = @BatchID;
        END
        -- Rollback DELETE: Restore the deleted record from log
        ELSE IF @action = 'D'
        BEGIN
            INSERT INTO account_master (
			acc_id,acc_name,acc_desc,ShortReportingName,LongReportingName,client_id,broker_id,base_curr,status,
			ReportingNameType,group_account,lock_date,handle_futures,account_type,error_limit,reporting_name,
			reporting_path,broker_trade_acceptance_limit,hold_equity,disabled_on_date,
			real_broker_id,MDMEntityTypeID,broker_acc_no,
			pns_style,default_accrual_source,interest_accrual_check_limit,
			dividend_accrual_check_limit,FundStartDate,AccountingEndDate,MDMTopicEntityID,MDMTradingBehaviour,
			MDMVersionNumber,MDMStartDate,MDMEndDate,version_date,version_source,MDMSlaPriority,
			CreateDate,EntityFlag,FasLockDate,BatchID )
            SELECT 
			acc_id,acc_name,acc_desc,ShortReportingName,LongReportingName,client_id,broker_id,base_curr,status,
			ReportingNameType,group_account,lock_date,handle_futures,account_type,error_limit,reporting_name,
			reporting_path,broker_trade_acceptance_limit,hold_equity,disabled_on_date,
			real_broker_id,MDMEntityTypeID,broker_acc_no,
			pns_style,default_accrual_source,interest_accrual_check_limit,
			dividend_accrual_check_limit,NULL,AccountingEndDate,MDMTopicEntityID,MDMTradingBehaviour,
			MDMVersionNumber,MDMStartDate,MDMEndDate,version_date,version_source,MDMSlaPriority,
			CreateDate,EntityFlag,FasLockDate,BatchID FROM account_master_log 
            WHERE acc_id = @acc_id AND BatchID = @BatchID;
        END

        FETCH NEXT FROM rollback_cursor INTO @acc_id, @action;
    END

    CLOSE rollback_cursor;
    DEALLOCATE rollback_cursor;

    COMMIT TRANSACTION;
END;
GO
